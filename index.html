<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Triple Power Poker</title>
  <style>
    /* ------------------------------------- */
    /* GLOBAL STYLES */
    /* ------------------------------------- */
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #1e3c72, #2a5298);
      color: white;
      font-family: Arial, sans-serif;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center; 
    }
    h1 {
      text-align: center;
      margin-top: 10px;
    }

    /* LOGO STYLES */
    #logo-container {
        font-family: 'Arial Black', Gadget, sans-serif;
        font-size: 48px;
        text-align: center;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        margin: 10px auto; 
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1.2;
        width: fit-content; 
    }

    .logo-triple {
        color: #FFD700; /* Gold */
        font-weight: 900;
        margin-right: 5px;
        letter-spacing: 2px;
    }

    .logo-power {
        color: #00c6ff; /* Electric Blue */
        font-weight: 900;
        margin-right: 5px;
        padding: 0 5px;
        border-bottom: 4px solid #0072ff; 
    }

    .logo-poker {
        color: #FFFFFF; /* Clean White */
        font-weight: 700;
        font-size: 44px;
        letter-spacing: 1px;
    }

    .logo-triple::before {
        content: '▲'; 
        color: #FFD700;
        font-size: 20px;
        margin-right: 5px;
        vertical-align: top;
    }
    /* END LOGO STYLES */
    
    /* ------------------------------------- */
    /* MAIN GAME LAYOUT (NEW FLEX CONTAINER) */
    /* ------------------------------------- */
    #game-area {
        display: flex;
        justify-content: center;
        align-items: flex-start; 
        width: 95%;
        max-width: 1200px;
        margin-top: 20px;
        flex-grow: 1; 
    }

    /* ------------------------------------- */
    /* PAYOUT BOXES (LEFT AND RIGHT) */
    /* ------------------------------------- */
    .payout-column {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 10px; 
        margin-top: 20px; 
    }

    .payout-box {
        background-color: #333;
        border: 2px solid #FFD700;
        border-radius: 8px;
        padding: 5px 10px;
        margin-bottom: 8px;
        width: 120px; 
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .payout-box:last-child {
        margin-bottom: 0;
    }

    .payout-name {
        font-size: 11px;
        font-weight: bold;
        color: #00c6ff;
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    .payout-score {
        font-size: 14px;
        font-weight: bold;
        color: #FFD700;
    }

    /* היילייט לזכייה פעילה */
    .payout-box.active-win {
        background-color: #008000; /* Green highlight */
        border-color: #FFFF00; /* Yellow border */
        box-shadow: 0 0 10px rgba(255, 255, 0, 0.7);
    }


    /* ------------------------------------- */
    /* HANDS GRID CONTAINER (Center) */
    /* ------------------------------------- */
    #hands-grid-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: fit-content;
        margin: 0 20px; 
    }

    #hands-grid {
        border: 5px solid #FFD700; 
        border-radius: 15px;
        padding: 10px;
        margin: 10px auto; 
        width: fit-content; 
        background-color: rgba(0, 0, 0, 0.3); 
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        transition: box-shadow 0.5s ease-out; 
    }
    #hands-grid.hand-falling-glow {
        box-shadow: 0 0 25px 10px rgba(255, 0, 0, 0.7), 
                    0 0 20px rgba(0,0,0,0.5); 
    }
    
    /* Shake animation applied ONLY to hand1 */
    #hand1.shake {
        animation: shake 0.1s linear 4; 
    }
    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }


    .hand {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 180px; 
      position: relative;
      margin-bottom: 10px; 
      transition: transform 0.1s; 
    }
    .hand:last-of-type {
        margin-bottom: 0;
    }
    .card-container {
        position: relative;
        margin: 5px;
        width: 100px;
        height: 150px;
    }
    .hand img {
      width: 100px;
      height: 150px;
      border: 2px solid white;
      border-radius: 5px;
      transition: border 0.6s, opacity 0.6s;
      cursor: default;
    }

    /* קלפי hand1 הופכים ללחיצים אחרי שלב הנפילה */
    #hand1 img {
        cursor: pointer;
    }
    
    /* מונע אינטראקציה עם קלף Hand1 אם המשחק אינו בשלב HOLD */
    #hand1.disabled-hold img {
        cursor: not-allowed !important;
    }

    /* סימון קלף נבחר */
    #hand1 img.selected {
        border: 4px solid #00c6ff; 
    }
    /* קלף מוחזק בשורות 2 ו-3 */
    .hand img.held-mirror {
        border: 4px solid #00c6ff;
    }

    /* כיתוב HELD */
    .held-label {
        position: absolute;
        top: -15px; 
        left: 50%;
        transform: translateX(-50%);
        background-color: #00c6ff;
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
        z-index: 5;
        display: none;
    }
    /* תיקון: הצג HELD רק אם התמונה הפנימית מסומנת */
    .card-container:has(img.selected) > .held-label {
        display: block;
    }
    /* הצגת HELD בשורות 2 ו-3 כשזה MIRROR */
    .card-container:has(img.held-mirror) > .held-label {
        display: block;
    }

    /* מיקום לתיבת הניקוד */
    .score-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        z-index: 10;
        opacity: 0;
        transition: opacity 1s, color 0.5s, border 0.5s, background-color 0.5s;
    }
    
    /* סגנונות זכייה מותאמים אישית (כאשר score > 0) */
    .score-box.win {
        opacity: 1;
    }
    .score-box.score-ROYAL-FLUSH {
        color: #FFFFFF;
        border: 2px solid #FFD700; 
        background-color: rgba(102, 0, 102, 0.9); 
    }
    .score-box.score-STRAIGHT-FLUSH {
        color: #FFFFFF;
        border: 2px solid #C0C0C0; 
        background-color: rgba(0, 100, 0, 0.9); 
    }
    .score-box.score-4-OF-A-KIND {
        color: #FF4500; 
        border: 2px solid #FF4500;
        background-color: rgba(0, 0, 0, 0.85);
    }
    .score-box.score-FULL-HOUSE {
        color: #FFA500; 
        border: 2px solid #FFA500;
        background-color: rgba(0, 0, 0, 0.85);
    }
    .score-box.score-FLUSH {
        color: #00FF00; 
        border: 2px solid #00FF00;
        background-color: rgba(0, 0, 0, 0.85);
    }
    .score-box.score-STRAIGHT {
        color: #FFFF00; 
        border: 2px solid #FFFF00;
        background-color: rgba(0, 0, 0, 0.85);
    }
    .score-box.score-3-OF-A-KIND {
        color: #00FFFF; 
        border: 2px solid #00FFFF;
        background-color: rgba(0, 0, 0, 0.85);
    }
    .score-box.score-TWO-PAIR {
        color: #7FFFD4; 
        border: 2px solid #7FFFD4;
        background-color: rgba(0, 0, 0, 0.85);
    }
    .score-box.score-PAIR-J- {
        color: #FFFFFF; 
        border: 2px solid #FFFFFF;
        background-color: rgba(0, 0, 0, 0.85);
    }
    /* END CUSTOM WIN STYLES */


    /* סגנונות אנימציית נפילה (שלב 1) */
    #hand1 img.falling {
        border: 4px solid yellow; 
        box-shadow: 0 0 15px yellow; 
        animation: fallDown 0.6s ease-in-out; 
    }
    /* אפקט נצנוץ קצר (כאשר אין נפילה) */
    #hand1 img.flicker {
        animation: flickerEffect 0.2s 3; 
    }
    @keyframes flickerEffect {
        0% { transform: scale(1.0); border-color: yellow; }
        50% { transform: scale(1.02); border-color: white; }
        100% { transform: scale(1.0); border-color: yellow; }
    }


    /* סגנון לקלפים ש"נלקחו" משורות 2 ו-3 */
    .hand img.taken {
        opacity: 0.2; 
        border: 2px solid darkred; 
    }
    
    @keyframes fallDown {
      0% { transform: translateY(-100px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    /* ------------------------------------- */
    /* BOTTOM CONTROL SECTION */
    /* ------------------------------------- */
    #bottom-controls-section {
        width: 100%;
        text-align: center;
        background-color: rgba(0, 0, 0, 0.3);
        padding: 10px 0; 
        margin-top: 20px; 
        box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.5);
    }

    #controls-container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap; 
        gap: 15px; 
    }

    /* עיצוב כפתור DEAL/DRAW */
    #mainButton {
      padding: 15px 40px; 
      font-size: 24px;   
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 5px 10px rgba(0,0,0,0.5); 
      transition: transform 0.2s, background 0.5s;
      background: linear-gradient(to right, #00c6ff, #0072ff); 
    }
    #mainButton:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    #mainButton[data-action="draw"] {
        background: linear-gradient(to right, #ffcc00, #ff9900); 
    }
    
    /* סטטוס בר ותיבות מעוצבות */
    .status-box {
        display: inline-flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 90px; 
        height: 45px; 
        border-radius: 8px;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .status-label {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
    }
    .status-value {
        font-size: 20px; 
        margin-top: 2px;
    }

    /* ---------- צבעים מעודכנים ---------- */
    #creditBox {
        background-color: #CC0000; /* אדום */
        border: 2px solid #FF5555;
    }
    #betBox {
        background-color: #B0C4DE; 
        color: #1e3c72;
        border: 2px solid #FFFFFF;
        position: relative; 
    }
    #betBox .bet-info {
        position: absolute;
        top: -15px; 
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        color: rgba(255, 255, 255, 0.8);
        background-color: rgba(0, 0, 0, 0.5);
        padding: 1px 4px;
        border-radius: 3px;
    }
    #winBox {
        background-color: #00AA00; /* ירוק */
        color: #FFFFFF; 
        border: 2px solid #7FFF00;
    }
  </style>
</head>
<body onload="initGame()">
    
  <audio id="soundDeal" src="SOUNDS/game-start-317318.mp3" preload="auto"></audio>
  <audio id="soundHold" src="SOUNDS/Button Click.mp3" preload="auto"></audio>
  <audio id="soundWin" src="SOUNDS/fiches_04.wav" preload="auto"></audio>
  <audio id="soundControl" src="SOUNDS/call check.mp3" preload="auto"></audio>


  <div id="logo-container">
    <span class="logo-triple">TRIPLE</span>
    <span class="logo-power">POWER</span>
    <span class="logo-poker">POKER</span>
  </div>
  
  <div id="game-area">
    
    <div id="left-payout-boxes" class="payout-column">
        <div class="payout-box" data-hand="ROYAL FLUSH"><div class="payout-name">ROYAL FLUSH</div><div class="payout-score">4000</div></div>
        <div class="payout-box" data-hand="STRAIGHT FLUSH"><div class="payout-name">STRAIGHT FLUSH</div><div class="payout-score">250</div></div>
        <div class="payout-box" data-hand="4 OF A KIND"><div class="payout-name">4 OF A KIND</div><div class="payout-score">125</div></div>
        <div class="payout-box" data-hand="FULL HOUSE"><div class="payout-name">FULL HOUSE</div><div class="payout-score">45</div></div> <div class="payout-box" data-hand="FLUSH"><div class="payout-name">FLUSH</div><div class="payout-score">30</div></div> </div>

    <div id="hands-grid-wrapper">
        <div id="hands-grid">
          <div class="hand" id="hand3">
            <div class="score-box" id="score3"></div>
          </div>
          <div class="hand" id="hand2">
            <div class="score-box" id="score2"></div>
          </div>
          <div class="hand" id="hand1">
            <div class="score-box" id="score1"></div>
          </div>
        </div>
    </div>

    <div id="right-payout-boxes" class="payout-column">
        <div class="payout-box" data-hand="STRAIGHT"><div class="payout-name">STRAIGHT</div><div class="payout-score">20</div></div>
        <div class="payout-box" data-hand="3 OF A KIND"><div class="payout-name">3 OF A KIND</div><div class="payout-score">15</div></div>
        <div class="payout-box" data-hand="TWO PAIR"><div class="payout-name">TWO PAIR</div><div class="payout-score">10</div></div> <div class="payout-box" data-hand="PAIR J+"><div class="payout-name">PAIR J+</div><div class="payout-score">5</div></div>
    </div>
  </div>

  <div id="bottom-controls-section">
      <div id="controls-container">

          <div class="status-box" id="creditBox">
              <span class="status-label">Credit</span>
              <span class="status-value" id="creditDisplay">500</span>
          </div>

          <div class="status-box" id="betBox">
              <span class="status-label">Bet</span>
              <span class="status-value" id="betDisplay">30</span>
          </div>
          
          <button id="mainButton" class="control-button" data-action="deal" onclick="handleControlClick()">DEAL</button>
          
          <div class="status-box" id="winBox">
              <span class="status-label">Win</span>
              <span class="status-value" id="totalWinDisplay">0</span>
          </div>
      </div>
  </div>


  <script>
    const suits = ["hearts", "diamonds", "clubs", "spades"];
    const ranks = ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"];
    const CARD_BACK_FILE = "card_back.png";
    const EMPTY_CARD_PLACEHOLDER = { file: `CARDS/${CARD_BACK_FILE}`, rank: '', suit: '' }; 

    // מצב גלובלי
    let selectedIndices = [];
    let finalHand1AfterImprovement = []; 
    let finalHand2AfterHold = [];
    let finalHand3AfterHold = [];
    let gameState = 'deal'; // 'deal', 'hold', 'draw', 'animating'

    // ניהול קרדיט והימור
    let credit = 500;
    const betAmount = 30; 
    
    // טבלת זכיות (Paytable) - מעודכנת
    const PAYTABLE = [
        { score: 4000, name: "ROYAL FLUSH", css: "score-ROYAL-FLUSH" },
        { score: 250, name: "STRAIGHT FLUSH", css: "score-STRAIGHT-FLUSH" },
        { score: 125, name: "4 OF A KIND", css: "score-4-OF-A-KIND" }, 
        { score: 45, name: "FULL HOUSE", css: "score-FULL-HOUSE" },    // UPDATED: 45
        { score: 30, name: "FLUSH", css: "score-FLUSH" },              // UPDATED: 30
        { score: 20, name: "STRAIGHT", css: "score-STRAIGHT" },        
        { score: 15, name: "3 OF A KIND", css: "score-3-OF-A-KIND" },
        { score: 10, name: "TWO PAIR", css: "score-TWO-PAIR" },        // UPDATED: 10
        { score: 5, name: "PAIR J+", css: "score-PAIR-J-" }            
    ];
    
    // פונקציות סאונד
    function playSound(id) {
        const audio = document.getElementById(id);
        if (audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Sound playback failed:", e));
        }
    }

    function initGame() {
        updateCreditDisplay();
        document.getElementById('betDisplay').textContent = betAmount;
        document.getElementById('totalWinDisplay').textContent = 0; 
        document.getElementById('hand1').classList.add('disabled-hold'); 
    }
    
    function updateCreditDisplay() {
        document.getElementById('creditDisplay').textContent = credit;
    }

    function createDeck() {
      const deck = [];
      for (let suit of suits) {
        for (let rank of ranks) {
          deck.push({ rank, suit, file: `CARDS/${rank}_of_${suit}.png` });
        }
      }
      return deck;
    }

    // חלוקת יד מחפיסה נתונה (מבצעת גם הסרה מהחפיסה)
    function dealHand(deck, size = 5) {
      const hand = [];
      for (let i = 0; i < size; i++) {
        const index = Math.floor(Math.random() * deck.length);
        if (deck.length > 0) {
            hand.push(deck.splice(index, 1)[0]);
        }
      }
      return hand;
    }
    
    // פונקציה לרינדור יד
    function renderHand(containerId, hand, indicesToMark = [], markClass = '') {
      const container = document.getElementById(containerId);
      container.innerHTML = `<div class="score-box" id="score${containerId.slice(-1)}"></div>`; 
      
      hand.forEach((card, index) => {
        const cardContainer = document.createElement("div");
        cardContainer.classList.add('card-container');

        const img = document.createElement("img");
        img.src = `${card.file}`;
        img.alt = `${card.rank} of ${card.suit}`;
        
        if (indicesToMark.includes(index)) {
          img.classList.add(markClass);
        }
        
        const heldLabel = document.createElement("span");
        heldLabel.classList.add('held-label');
        heldLabel.textContent = "HELD";

        if (containerId === 'hand1') {
            img.dataset.index = index;
            img.onclick = toggleHold;
        }

        // שימור הבחירה של HELD בעת רינדור hand1
        if (containerId === 'hand1' && selectedIndices.includes(index)) {
             img.classList.add('selected');
        }

        cardContainer.appendChild(img);
        cardContainer.appendChild(heldLabel);
        container.appendChild(cardContainer);
      });
    }

    // פונקציה לרינדור גב קלף (משמשת בשלב המעבר ל-DRAW)
    function renderBacks(containerId, heldCardsIndices = []) {
        const container = document.getElementById(containerId);
        container.innerHTML = `<div class="score-box" id="score${containerId.slice(-1)}"></div>`; 
        
        for (let i = 0; i < 5; i++) {
            const cardContainer = document.createElement("div");
            cardContainer.classList.add('card-container');
            
            const img = document.createElement("img");
            
            // תווית HELD נפרדת ל-MIRROR
            const heldLabel = document.createElement("span");
            heldLabel.classList.add('held-label');
            heldLabel.textContent = "HELD";

            if (heldCardsIndices.includes(i)) {
                // הצגת הקלף המוחזק (מראה)
                const heldCard = finalHand1AfterImprovement[i];
                img.src = `${heldCard.file}`;
                img.alt = `${heldCard.rank} of ${heldCard.suit}`;
                img.classList.add('held-mirror'); 
                
                cardContainer.appendChild(img);
                cardContainer.appendChild(heldLabel); // הצגת תווית HELD
            } else {
                // הצגת גב הקלף
                img.src = `CARDS/${CARD_BACK_FILE}`;
                img.alt = `Card Back`;
                cardContainer.appendChild(img);
            }
            container.appendChild(cardContainer);
        }
    }
    
    function getRankValue(rank) {
        if (!isNaN(parseInt(rank))) return parseInt(rank);
        if (rank === "J") return 11;
        if (rank === "Q") return 12;
        if (rank === "K") return 13;
        if (rank === "A") return 14;
        return 0;
    }
    
    function isAlmostFlush(hand, testIndex, testCard) {
        const tempHand = hand.slice();
        tempHand[testIndex] = testCard;
        
        const suitCounts = {};
        tempHand.forEach(card => {
            if (card && card.suit) {
             suitCounts[card.suit] = (suitCounts[card.suit] || 0) + 1;
            }
        });

        return Object.values(suitCounts).some(count => count >= 4);
    }
    
    function evaluateHand(hand, returnDetails = false) {
        const rankCounts = {};
        const suitCounts = {};
        const values = [];

        hand.forEach(card => {
            if (!card || !card.rank) return; 

            rankCounts[card.rank] = (rankCounts[card.rank] || 0) + 1;
            suitCounts[card.suit] = (suitCounts[card.suit] || 0) + 1;

            let val = getRankValue(card.rank);
            values.push(val);
        });
        
        if (values.length !== 5) return returnDetails ? { score: 0, name: "NO WIN" } : 0; 

        values.sort((a, b) => a - b);
        const isFlush = Object.values(suitCounts).some(count => count === 5);
        
        const uniqueSortedValues = [...new Set(values)];
        let isStraight = uniqueSortedValues.length === 5 && uniqueSortedValues.every((v, i, arr) => i === 0 || v === arr[i - 1] + 1);
        if (!isStraight && values.join() === "2,3,4,5,14") {
            isStraight = true;
        }
        
        const counts = Object.values(rankCounts).sort((a, b) => b - a);
        const hasCounts = counts.length > 0;
        
        let result = { score: 0, name: "NO WIN", css: "" };

        if (isFlush && values.join() === "10,11,12,13,14") result = PAYTABLE.find(p => p.name === "ROYAL FLUSH") || result;
        else if (isFlush && isStraight) result = PAYTABLE.find(p => p.name === "STRAIGHT FLUSH") || result;
        else if (hasCounts && counts[0] === 4) result = PAYTABLE.find(p => p.name === "4 OF A KIND") || result;
        else if (hasCounts && counts[0] === 3 && counts[1] === 2) result = PAYTABLE.find(p => p.name === "FULL HOUSE") || result;
        else if (isFlush) result = PAYTABLE.find(p => p.name === "FLUSH") || result; 
        else if (isStraight) result = PAYTABLE.find(p => p.name === "STRAIGHT") || result;
        else if (hasCounts && counts[0] === 3) result = PAYTABLE.find(p => p.name === "3 OF A KIND") || result;
        else if (hasCounts && counts[0] === 2 && counts[1] === 2) result = PAYTABLE.find(p => p.name === "TWO PAIR") || result;
        else if (hasCounts && counts[0] === 2) {
            const highPair = Object.keys(rankCounts).find(r => rankCounts[r] === 2 && getRankValue(r) >= 11);
            if (highPair) result = PAYTABLE.find(p => p.name === "PAIR J+") || result;
        }

        return returnDetails ? result : result.score;
    }

    function tryImproveBaseHand(baseHand, row2, row3) {
        let bestHand = baseHand.slice();
        let bestScore = evaluateHand(baseHand);
        let bestFallingIndices = [];
        let bestSource = { 1: 'hand1', 2: 'hand1', 3: 'hand1' }; 

        // קלפי הפינה קבועים
        const fixedCard0 = baseHand[0];
        const fixedCard4 = baseHand[4];

        // האינדקסים המרכזיים
        const centralIndices = [1, 2, 3];
        
        const candidates = centralIndices.map(i => [
            { card: baseHand[i], source: 'hand1', index: i }, // קלף מקורי משורה 1
            { card: row2[i], source: 'row2', index: i },      // קלף משורה 2
            { card: row3[i], source: 'row3', index: i }       // קלף משורה 3
        ]);

        // בדיקת 3 * 3 * 3 = 27 צירופי קלפים מרכזיים
        for (let c1 = 0; c1 < 3; c1++) { 
            for (let c2 = 0; c2 < 3; c2++) { 
                for (let c3 = 0; c3 < 3; c3++) { 
                    
                    const testHand = [fixedCard0]; // מתחילים עם קלף 0 הקבוע
                    const currentFallingIndices = [];
                    const currentSource = {};
                    let isInvalidChange = false;

                    const combinationSelections = [
                        candidates[0][c1], 
                        candidates[1][c2], 
                        candidates[2][c3]
                    ];

                    centralIndices.forEach((baseIndex, comboIndex) => {
                        const chosenCard = combinationSelections[comboIndex];
                        const originalCard = baseHand[baseIndex];
                        const isChange = chosenCard.source !== 'hand1';
                        
                        // בדיקת "כמעט פלאש" (החלפה של קלף באותה דרגה אך חליפה שונה)
                        if (isChange && getRankValue(chosenCard.card.rank) === getRankValue(originalCard.rank)) {
                            const tempHandForFlushCheck = baseHand.slice();
                            tempHandForFlushCheck[baseIndex] = chosenCard.card;

                            if (isAlmostFlush(tempHandForFlushCheck, baseIndex, chosenCard.card)) {
                                isInvalidChange = true;
                            }
                        }
                        
                        testHand.push(chosenCard.card); // הוספת הקלף הנבחר (1, 2, או 3)
                        currentSource[baseIndex] = chosenCard.source;
                        
                        // קלפים נופלים רק אם יש שינוי (כלומר מקורם הוא row2 או row3)
                        if (isChange) {
                            currentFallingIndices.push(baseIndex);
                        }
                    });
                    
                    testHand.push(fixedCard4); // הוספת קלף 4 הקבוע

                    if (isInvalidChange) continue; 

                    const score = evaluateHand(testHand);

                    if (score > bestScore) {
                        bestScore = score;
                        bestHand = testHand;
                        bestFallingIndices = currentFallingIndices.filter((v, i, a) => a.indexOf(v) === i); 
                        bestSource = currentSource;
                    }
                }
            }
        }
        
        // ודא ש-bestHand תמיד באורך 5 (הוא אמור להיות)
        if (bestHand.length !== 5) {
            return { hand: baseHand, fallingIndices: [], source: { 1: 'hand1', 2: 'hand1', 3: 'hand1' } };
        }

        return { hand: bestHand, fallingIndices: bestFallingIndices, source: bestSource };
    }
    
    /**
     * פונקציה לסימון/ביטול סימון של קלפים להחזקה (HOLD)
     */
    function toggleHold(event) {
        // *** נעילה במהלך הנפילה - כולל הצגת הודעה ***
        if (gameState !== 'hold') {
            alert("Please wait for the drop phase animation to finish.");
            return;
        }
        
        playSound('soundHold'); // השמעת צליל HOLD

        const img = event.target;
        const index = parseInt(img.dataset.index);
        const mainButton = document.getElementById('mainButton');

        // 1. טיפול בסימון ב-hand1
        if (img.classList.contains('selected')) {
            img.classList.remove('selected');
            selectedIndices = selectedIndices.filter(i => i !== index); 
        } else {
            img.classList.add('selected');
            selectedIndices.push(index); 
        }
        
        // 2. עדכון מצב שורות 2 ו-3 (מראה והסתרת שאר הקלפים)
        finalHand2AfterHold = finalHand1AfterImprovement.map((card, i) => selectedIndices.includes(i) ? card : EMPTY_CARD_PLACEHOLDER);
        finalHand3AfterHold = finalHand1AfterImprovement.map((card, i) => selectedIndices.includes(i) ? card : EMPTY_CARD_PLACEHOLDER);


        // רינדור גב הקלף ושכפול הקלפים המוחזקים (מראה)
        renderBacks('hand2', selectedIndices); 
        renderBacks('hand3', selectedIndices); 
        
        // 3. עדכון כפתור הבקרה ל-DRAW
        mainButton.textContent = 'DRAW';
        mainButton.dataset.action = 'draw';
        
        // רינדור hand1 מחדש כדי לוודא שתוויות HELD מעודכנות
        renderHand("hand1", finalHand1AfterImprovement, selectedIndices, 'selected');
    }
    
    /**
     * פונקציית בקרה ראשית
     */
    function handleControlClick() {
        const mainButton = document.getElementById('mainButton');

        if (mainButton.dataset.action === 'deal') {
            if (credit < betAmount) {
                alert("Insufficient Credit for a new bet. Please refresh to start a new game.");
                return;
            }
            // *** נעל את הכפתור לפני תחילת התהליך (שכולל את הנפילה) ***
            mainButton.disabled = true; 
            playSound('soundControl'); // צליל DEAL/DRAW
            dealCards();
        } else if (mainButton.dataset.action === 'draw') {
            playSound('soundControl'); // צליל DEAL/DRAW
            drawCards();
        }
    }


    /**
     * שלב סופי: DRAW - שליפה וקביעת ניקוד
     */
    function drawCards() {
        const mainButton = document.getElementById('mainButton');
        mainButton.disabled = true;

        // נקה את היילייט מתיבות הזכייה לפני רינדור מחדש
        document.querySelectorAll('.payout-box').forEach(box => box.classList.remove('active-win'));

        // חפיסות נפרדות לשליפה מחדש (שלב שני)
        const deck1 = createDeck();
        const deck2 = createDeck();
        const deck3 = createDeck();

        const newHand1 = finalHand1AfterImprovement.slice(); 
        const newHand2 = finalHand2AfterHold.slice(); 
        const newHand3 = finalHand3AfterHold.slice(); 
        
        for (let i = 0; i < 5; i++) {
            if (!selectedIndices.includes(i)) {
                // שליפת 3 קלפים חדשים (כל אחד מחפיסה נפרדת)
                const card1 = dealHand(deck1, 1)[0];
                const card2 = dealHand(deck2, 1)[0];
                const card3 = dealHand(deck3, 1)[0];
                
                newHand1[i] = card1 || EMPTY_CARD_PLACEHOLDER;
                newHand2[i] = card2 || EMPTY_CARD_PLACEHOLDER;
                newHand3[i] = card3 || EMPTY_CARD_PLACEHOLDER;
            } else {
                // קלפים מוחזקים משוחזרים 
                newHand2[i] = finalHand1AfterImprovement[i];
                newHand3[i] = finalHand1AfterImprovement[i];
            }
        }
        
        gameState = 'draw';
        
        // הסרת האפשרות ללחוץ על קלפים (וודא שזה נשאר מושבת עד הדיל הבא)
        document.getElementById('hand1').classList.add('disabled-hold'); 
        
        // הצגת הידיים הסופיות
        renderHand("hand1", newHand1, selectedIndices, 'selected');
        renderHand("hand2", newHand2, selectedIndices, 'held-mirror');
        renderHand("hand3", newHand3, selectedIndices, 'held-mirror');
        
        // קביעת ניקוד ועדכון קרדיט
        setTimeout(() => {
            const scoreDetails1 = displayScore('score1', newHand1);
            const scoreDetails2 = displayScore('score2', newHand2);
            const scoreDetails3 = displayScore('score3', newHand3);
            
            const totalWin = scoreDetails1.score + scoreDetails2.score + scoreDetails3.score;
            
            if (totalWin > 0) {
                playSound('soundWin'); // צליל זכייה
                highlightPayoutBox(scoreDetails1.name); // הדגש את תיבת הזכייה עבור יד 1
                // ניתן להוסיף הדגשה גם עבור ידיים 2 ו-3 אם יש זכייה שונה
                if (scoreDetails2.score > 0 && scoreDetails2.name !== scoreDetails1.name) highlightPayoutBox(scoreDetails2.name);
                if (scoreDetails3.score > 0 && scoreDetails3.name !== scoreDetails1.name && scoreDetails3.name !== scoreDetails2.name) highlightPayoutBox(scoreDetails3.name);
            }
            
            document.getElementById('totalWinDisplay').textContent = totalWin; // Update WIN display
            credit += totalWin; 
            updateCreditDisplay();
            
            // עדכון כפתור הבקרה למצב DEAL חדש
            mainButton.textContent = 'DEAL';
            mainButton.dataset.action = 'deal';
            mainButton.disabled = false;

        }, 500); 
        
        selectedIndices = [];
    }

    function displayScore(scoreBoxId, hand) {
        const result = evaluateHand(hand, true);
        const scoreBox = document.getElementById(scoreBoxId);
        
        scoreBox.classList.remove('win', 'no-win');
        PAYTABLE.forEach(p => scoreBox.classList.remove(p.css)); 

        if (result.score === 0) {
            scoreBox.textContent = ""; 
        } else {
            const scoreText = `${result.name} ${result.score}`; 
            scoreBox.classList.add('win');
            scoreBox.classList.add(result.css); 

            scoreBox.textContent = scoreText;
        }
        return result;
    }

    // פונקציה חדשה להדגשת תיבת הזכייה
    function highlightPayoutBox(handName) {
        const allPayoutBoxes = document.querySelectorAll('.payout-box');
        allPayoutBoxes.forEach(box => {
            // נקה את כל התיבות בהתחלה (כדי למנוע הדגשת יתר)
            box.classList.remove('active-win'); 
        });
        
        // הדגש את התיבה הרלוונטית
        allPayoutBoxes.forEach(box => {
            if (box.dataset.hand === handName) {
                box.classList.add('active-win');
            }
        });
    }

    /**
     * שלב 1: חלוקת קלפים ראשונית ושיפור אוטומטי
     */
    function dealCards() {
      const mainButton = document.getElementById('mainButton');
      
      // נקה את היילייט מתיבות הזכייה לפני התחלת דיל חדש
      document.querySelectorAll('.payout-box').forEach(box => box.classList.remove('active-win'));

      // *** נעל את ה-HOLD באופן פיזי וקבע מצב אנימציה ***
      document.getElementById('hand1').classList.add('disabled-hold');
      gameState = 'animating'; 
      
      // איפוס מצב
      document.getElementById('score1').classList.remove('win', 'no-win');
      document.getElementById('score2').classList.remove('win', 'no-win');
      document.getElementById('score3').classList.remove('win', 'no-win');
      document.getElementById('totalWinDisplay').textContent = 0; 
      selectedIndices = [];

      // הפחתת הימור לפני חלוקת קלפים
      credit -= betAmount;
      updateCreditDisplay();
      
      // *** חלוקה ראשונית מחפיסה אחת למניעת כפילויות ***
      const singleDeck = createDeck();
      
      let hand1 = dealHand(singleDeck, 5); 
      const hand2 = dealHand(singleDeck, 5); 
      const hand3 = dealHand(singleDeck, 5); 
      
      // *** הצגת הידיים המקוריות למשך 2 שניות (לפני השיפור) ***
      renderHand("hand1", hand1); 
      renderHand("hand2", hand2);
      renderHand("hand3", hand3);

      // 2 שניות השהייה לפני חישוב השיפור והנפילות
      setTimeout(() => {
        
        // --- חישוב השיפור האוטומטי מתבצע כאן ---
        const result = tryImproveBaseHand(hand1.slice(), hand2.slice(), hand3.slice());
        const improvedHand1 = result.hand;
        const fallingIndices = result.fallingIndices;
        const bestSource = result.source;
        
        finalHand1AfterImprovement = improvedHand1; 
        
        // *** שומרים את הידיים המקוריות שחולקו במשתנים הגלובליים ***
        finalHand2AfterHold = hand2; 
        finalHand3AfterHold = hand3;

        const takenFromRow2 = [];
        const takenFromRow3 = [];

        // אינדקסים 1, 2, 3 הם הקלפים המרכזיים
        [1, 2, 3].forEach(i => {
          if (bestSource[i] === 'row2') {
            takenFromRow2.push(i);
          } else if (bestSource[i] === 'row3') {
            takenFromRow3.push(i);
          }
        });
        
        // הוספת ה"זוהר" האדום מסביב לכל הגריד של הידיים
        document.getElementById('hands-grid').classList.add('hand-falling-glow');
        playSound('soundDeal'); // צליל נפילת קלפים (Deal Sound)

        // אם יש קלפים נופלים - הצג אנימציה
        if (fallingIndices.length > 0) {
            // הצגת השיפור עם אנימציית נפילה
            renderHand("hand1", improvedHand1, fallingIndices, 'falling');

            // רינדור מחדש עם הקלפים ש"נלקחו" באפקט עמום
            renderHand("hand2", hand2, takenFromRow2, 'taken');
            renderHand("hand3", hand3, takenFromRow3, 'taken');
        } else {
            // *** אם לא התקיימה נפילה - הוספת אפקט נצנוץ קצר (Flicker) ***
            renderHand("hand1", improvedHand1, [0, 1, 2, 3, 4], 'flicker');
            // עדיין צריך לעדכן את ידיים 2 ו-3 ללא אפקט taken, רק לוודא שהן שם
            renderHand("hand2", hand2);
            renderHand("hand3", hand3);
        }

        
        // לאחר האנימציה, הסר את זוהר הנפילה והפוך את hand1 ללחיץ
        setTimeout(() => {
            // הסרת הזוהר והוספת הנענוע ל-Hand 1
            const handsGrid = document.getElementById('hands-grid');
            const hand1Div = document.getElementById('hand1');
            
            handsGrid.classList.remove('hand-falling-glow');
            hand1Div.classList.add('shake');

            // נקה את ה-shake animation לאחר 400ms
            setTimeout(() => {
                hand1Div.classList.remove('shake');
            }, 400);

            
            // לוודא ש-hand1 הוא רק improvedHand1 (בלי flicker או falling) ושהוא לחיץ
            renderHand("hand1", improvedHand1); 
            
            // *** שחרור הנעילה והגדרת מצב HOLD ***
            document.getElementById('hand1').classList.remove('disabled-hold');
            gameState = 'hold';
            // ************************************

            // עדכון כפתור ל-DRAW
            mainButton.textContent = 'DRAW';
            mainButton.dataset.action = 'draw';
            mainButton.disabled = false;
            
        }, 600); // 600ms כדי לתאם עם משך אנימציית fallDown/flicker

      }, 2000); // השהייה של 2 שניות לפני אנימציית הנפילה
    }
  </script>
</body>
</html>