<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwitchUp Poker - FINAL WORKING DESIGN</title>
    <style>
        /* --- General Styling and Layout (DEEP NAVY BLUE) --- */
        body {
            font-family: Arial, sans-serif;
            background-color: #000050; /* Deep Navy Blue */
            color: #FFF; 
            text-align: center;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #main-container {
            display: block;
            max-width: 1400px;
            margin: 20px auto;
            width: 98%; 
            padding: 0;
        }

        /* --- Game Container: Single Unified Area --- */
        #game-container {
            background-color: #000080; /* Navy Blue (Contrast) */
            border-radius: 15px;
            border: 4px solid #FFD700; /* Gold border */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 10px; 
            width: 100%; 
            height: auto;
            min-height: 90vh; 
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        /* --- Title Styling (Top Center) --- */
        #game-container h1 {
            font-family: 'Georgia', serif; 
            font-size: 3.2em; 
            font-weight: 900;
            letter-spacing: 5px;
            margin-top: 0;
            margin-bottom: 15px;
            text-transform: uppercase;
            
            color: #FFD700; 
            text-shadow: 
                -3px -3px 0 #8B0000, 
                 3px -3px 0 #8B0000,
                -3px 3px 0 #8B0000,
                 3px 3px 0 #8B0000,
                 0 0 10px rgba(255, 255, 255, 0.7); 
        }

        /* --- New Global Controls Container (Top Left) --- */
        #global-controls {
            position: absolute;
            top: 25px;
            left: 20px;
            z-index: 100; /* Ensure it's on top of everything */
            display: flex;
            gap: 10px;
        }

        .control-icon {
            background-color: #CC0000;
            color: #FFD700;
            border: 2px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5); 
            transition: background-color 0.2s;
        }

        .control-icon:hover {
            background-color: #8B0000;
        }


        /* --- Payout Table (Top Right) --- */
        #payout-container {
            position: absolute;
            top: 15px;
            right: 5px; 
            background-color: #000050; 
            padding: 15px;
            width: 250px; 
            border-radius: 10px;
            border: 3px solid #CC0000;
            z-index: 10;
        }

        #payout-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.1em;
            margin-top: 15px;
        }
        
        #payout-table th {
            padding: 8px 10px;
            background-color: #8B0000; 
            color: #FFD700; 
            border-bottom: 2px solid #FFD700;
        }

        #payout-table tr.highlight-win td {
             background-color: #FFD700 !important;
             color: #000;
             font-weight: bold;
        }

        /* --- Stats Bar (Below Title, above cards) --- */
        #stats-bar-local {
            display: flex;
            justify-content: space-around; 
            width: 70%; 
            max-width: 800px;
            margin-bottom: 20px; 
            padding: 15px 0; 
            background-color: #CC0000; 
            border-radius: 5px;
            border: 2px solid #FFD700; 
            color: #FFD700; 
            font-family: 'Courier New', monospace; 
        }

        .stat-box {
            font-size: 1.2em; 
            font-weight: bold;
            flex: 1; 
            text-align: center;
        }
        
        #credits-stat, #bet-stat, #winnings-stat {
            color: #FFFFFF; 
            text-shadow: 0 0 3px #000;
            font-size: 1.4em; 
            display: inline-block;
        }

        /* --- Card Display Area (Below Stats) --- */
        #card-area-wrapper {
             width: 80%;
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: flex-start;
             
             /* ★ FIX: 注专 拽 住 - 注 转 ★ */
             position: static; 
             margin-top: 50px; 
        }
        
        #card-area {
            display: flex;
            justify-content: center;
            gap: 20px; 
            margin-bottom: 10px; 
            width: 100%; 
            min-height: 220px; 
        }
        
        .card-slot {
            position: relative; 
            display: flex; 
            flex-direction: column;
            align-items: center;
            gap: 15px; 
        }
        
        /* ★ NEW: HOLD Indicator above the card ★ */
        .hold-indicator {
            position: absolute;
            top: -30px; 
            z-index: 10;
            font-size: 1.2em;
            font-weight: bold;
            color: #FFFF00; 
            background-color: #CC0000;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #FFD700;
            visibility: hidden;
            pointer-events: none; 
            transition: visibility 0.1s;
        }
        
        .hold-indicator.held {
             visibility: visible;
             background-color: #00CC00;
             color: #000050;
             border-color: #008000;
        }
        
        .card-image {
            width: 145px; 
            height: 205px; 
            background-color: #fff;
            border: 3px solid transparent;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            position: relative; 
        }
        
        .card-image.modified {
            border: 4px solid #00FF00; /* 专拽 拽 */
            box-shadow: 0 0 15px #00FF00; /*  专拽 */
        }
        
        /* ★ Action Icons below cards ★ */
        .card-action-icon {
            position: absolute;
            width: 45px; 
            height: 45px; 
            border-radius: 8px; 
            background-color: #FFFFFF; /* 专拽注  */
            color: #CC0000; /*  驻 */
            border: 2px solid #FFD700;
            font-size: 1.5em; 
            font-weight: bold;
            cursor: pointer;
            line-height: 40px; 
            text-align: center;
            z-index: 50; 
            transition: background-color 0.1s;
            box-shadow: 0 0 8px rgba(0,0,0,0.8); 
        }
        
        .card-action-icon .red-suit-symbol { color: #CC0000; } 
        .card-action-icon .black-suit-symbol { color: #000000; } 

        .card-action-icon:hover:not(:disabled) {
            background-color: #FFD700; 
        }

        .card-action-icon:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background-color: #555555;
        }

        .booster-icon {
            bottom: -55px; 
            left: 50%;
            transform: translateX(-140%); 
        }

        .flush-icon {
            bottom: -55px; 
            left: 50%;
            transform: translateX(40%); 
        }


        /* --- Mirror Joker Button (Bottom Center) --- */
        #mirror-joker-container {
            width: 100%;
            margin-top: 50px; 
        }

        #mirror-joker-button {
            padding: 8px 30px; 
            font-size: 1.1em; 
            border: 4px solid #FFD700;
            background-color: #008000; 
            color: #FFD700;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 0 #005000;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        #mirror-joker-button:hover:not(:disabled) {
            background-color: #006400;
        }
        
        #mirror-joker-button:active:not(:disabled) {
            box-shadow: 0 2px 0 #005000;
            transform: translateY(3px);
        }

        #mirror-joker-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* --- Status Messages (Above Cards) --- */
        #status-area-bottom {
            width: 100%;
            max-width: 750px;
            margin-bottom: 10px; 
            padding: 5px 0;
            min-height: 50px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #message-area {
            font-size: 1.8em; 
            color: #FFFF00; /* 爪 专 */
            font-weight: bold;
            min-height: 30px;
            margin-bottom: 10px; 
        }
        
        /* --- Joker Cards (Vertical, Top Left) - Display Only --- */
        #action-cards-container {
            position: absolute;
            top: 80px;  /*  -5 住" */
            left: 20px;
            display: flex;
            flex-direction: column; 
            justify-content: flex-start;
            gap: 5px; /*  0px - 注 专  转转 */
            padding: 0;
            width: 230px;
            z-index: 10;
        }
        
        .action-card-slot {
             transition: opacity 0.3s ease-in-out;
             cursor: default !important; 
             display: flex;
             flex-direction: column; 
             align-items: center; 
             height: 255px; /*  -20%  转  砖 */
             gap: 0; 
        }
        
        .action-card-button {
            width: 198px; /* 20% 转专  */
            height: 251px; /* 20% 转专  */
            background-color: transparent !important; 
            color: white;
            font-size: 1.5em; 
            line-height: 1.1;
            border: none;
            border-radius: 8px;
            background-size: contain !important; 
            background-repeat: no-repeat !important;
            background-position: center !important;
            cursor: default !important; 
        }
        
        /* ★ NEW: Styling for icon text below side images (Hidden now) ★ */
        .action-card-icon-display {
             display: none;
        }


        .action-card-slot.used .action-card-button {
             opacity: 0.5; 
        }
        
        /* --- Control Buttons (Bottom Center) --- */
        #control-buttons {
            width: 100%;
            display: flex;
            justify-content: center;
            position: absolute;
            bottom: 60px; 
        }

        #action-button {
            padding: 20px 100px; 
            font-size: 1.7em; 
            border: 4px solid #FFD700; 
            background-color: #CC0000; 
            color: #FFD700; 
            font-weight: bold;
            box-shadow: 0 5px 0 #8B0000; 
            border-radius: 10px;
            cursor: pointer;
        }

        /* --- Company Logo Styling (Absolute Bottom Left) --- */
        /* 住专 转 拽 砖  爪 砖  */

        /* --- NEW: CSS for the logo --- */
        .brightly-logo-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 11;
            font-family: Arial, sans-serif;
            text-align: center;
            color: #FFD700; /* Gold color */
            background-color: transparent; 
        }

        .brightly-logo-icon {
            display: block;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #FFD700 30%, transparent 30%); /* 爪 */
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            margin: 0 auto;
        }

        .brightly-logo-icon:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background-color: #CC0000; /*   转专 */
            border-radius: 50%;
        }

        .brightly-logo-icon::after {
            content: 'B G'; /* Brightly Games */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            font-weight: bold;
            color: #FFD700; /* 爪 */
            line-height: 1;
        }

        .brightly-logo-text h2 {
            margin: 5px 0 0;
            font-size: 1.5em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .brightly-logo-text h3 {
            margin: 0;
            font-size: 1em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #CC0000; /* Red color */
        }


        /* FIX: Hide text on card image (display only the image) */
        .card-image.has-image {
            font-size: 0; 
        }
        
        /* ======================================================= */
        /* --- MOBILE RESPONSIVENESS (BREAKPOINT: 1024px) --- */
        /* ======================================================= */
        @media (max-width: 1024px) {
            
            #game-container {
                height: auto;
                min-height: 90vh;
                padding: 10px;
            }
            
            h1 {
                font-size: 2.2em !important;
            }

            /* --- Global Controls: Moved to static, center on mobile --- */
            #global-controls {
                position: static;
                margin: 10px auto;
                justify-content: center;
            }
            .control-icon {
                width: 35px;
                height: 35px;
                font-size: 1.2em;
            }


            /* --- Payout Table: Moved to full width, below title --- */
            #payout-container {
                position: static;
                width: 95%;
                margin: 10px auto;
                padding: 10px;
            }

            /* --- Stats Bar: Full width, reduced padding --- */
            #stats-bar-local {
                width: 95%;
                padding: 10px 0;
                margin-bottom: 10px;
            }

            .stat-box {
                font-size: 1em;
            }
            
            /* --- Joker Cards: Moved to full width, below stats (Adjusted top) --- */
            #action-cards-container {
                position: static;
                height: auto;
                flex-direction: row; /* Horizontal alignment on mobile */
                width: 100%;
                justify-content: space-around;
                gap: 5px;
                margin-bottom: 15px;
            }

            .action-card-slot {
                height: auto;
                flex-direction: column;
            }
            .action-card-button {
                width: 60px; 
                height: 90px;
            }
            
            .action-card-icon-display {
                display: none; /* Removed from previous versions, kept for consistency */
            }
            
            /* --- Card Area: Center of screen --- */
            #card-area-wrapper {
                position: static;
                top: auto;
                left: auto;
                transform: none;
                width: 100%;
                margin-top: 10px;
            }
            
            /* --- Playing Cards: Smaller size for phone width --- */
            #card-area {
                gap: 5px;
                width: 98%;
                margin-bottom: 5px;
            }

            .card-image {
                width: 55px; /* MODIFIED: Smaller width */
                height: 80px; /* MODIFIED: Smaller height */
            }

            .hold-indicator {
                 top: -25px;
                 font-size: 1em;
            }
            
            /* ★ Action Icons below cards (Mobile) ★ */
            .card-action-icon {
                width: 35px; 
                height: 35px; 
                font-size: 1em;
                line-height: 30px;
                border-width: 2px;
            }
            .booster-icon {
                bottom: -40px; 
                left: 50%;
                transform: translateX(-120%); 
            }
            .flush-icon {
                bottom: -40px; 
                left: 50%;
                transform: translateX(20%); 
            }

            
            #mirror-joker-container {
                margin-top: 40px; 
            }

            #mirror-joker-button {
                padding: 6px 20px;
                font-size: 0.9em;
            }
            
            /* --- Status Area --- */
            #status-area-bottom {
                margin-bottom: 10px;
                margin-top: 0; 
            }
            
            /* --- Control Buttons: Normal position, reduced size --- */
            #control-buttons {
                position: static;
                padding-bottom: 10px;
            }
            
            #action-button {
                padding: 15px 50px;
                font-size: 1.4em;
            }

            /* --- Footer/Log: Position at absolute bottom/corner --- */
            /* 住专  转 拽  转 -media query */
        }
        /* ======================================================= */
    </style>
</head>
<body>

    <audio id="sound-deal-draw" src="SOUNDS/dealing-card.wav" preload="auto"></audio>
    <audio id="sound-hold" src="SOUNDS/Button Click.mp3" preload="auto"></audio>
    <audio id="sound-win" src="SOUNDS/correct-choice.wav" preload="auto"></audio>
    <audio id="sound-action-card" src="SOUNDS/HELD.mp3" preload="auto"></audio>
    <div id="main-container">
        
        <div id="game-container">
            
            <div class="brightly-logo-container">
                <div class="brightly-logo-icon"></div>
                <div class="brightly-logo-text">
                    <h2>BRIGHTLY</h2>
                    <h3>GAMES</h3>
                </div>
            </div>

            <h1>SWITCHUP POKER</h1>
            
            <div id="global-controls">
                <button id="sound-toggle" class="control-icon" title="Toggle Sound"></button>
                <button id="help-button" class="control-icon" title="Game Help">?</button>
            </div>
            
            <div id="stats-bar-local">
                <div class="stat-box">Credits: <span id="credits-stat">500</span></div>
                <div class="stat-box">Total Bet: <span id="bet-stat">10</span></div>
                <div class="stat-box">Last Win: <span id="winnings-stat">0</span></div>
            </div>

            <div id="payout-container">
                <h2>Payouts (5x)</h2>
                <table id="payout-table">
                    <thead>
                        <tr>
                            <th>Hand</th>
                            <th>Pays (Credits)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-hand="Royal Flush"><td>Royal Flush</td><td>4000</td></tr>
                        <tr data-hand="Straight Flush"><td>Straight Flush</td><td>250</td></tr>
                        <tr data-hand="Four of a Kind"><td>4 of a Kind</td><td>125</td></tr> 
                        <tr data-hand="Full House"><td>Full House</td><td>45</td></tr>
                        <tr data-hand="Flush"><td>Flush</td><td>30</td></tr>
                        <tr data-hand="Straight"><td>Straight</td><td>20</td></tr>
                        <tr data-hand="Three of a Kind"><td>3 of a Kind</td><td>15</td></tr>
                        <tr data-hand="Two Pair"><td>Two Pair</td><td>10</td></tr>
                        <tr data-hand="Jacks or Better"><td>Jacks or Better</td><td>5</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="action-cards-container">
            </div>

            <div id="card-area-wrapper">
                <div id="status-area-bottom">
                    <div id="message-area">Click 'DEAL' to start.</div>
                    <div id="hand-status"></div>
                </div>
                 
                <div id="card-area">
                </div>
                
                <div id="mirror-joker-container">
                    <button id="mirror-joker-button" class="action-control-button" 
                            onclick="game.useCardAction(null, 'mirror_hand')">
                         MIRROR JOKER
                    </button>
                </div>
            </div>

            <div id="control-buttons">
                <button id="action-button" onclick="game.handleActionButton()">DEAL</button>
            </div>
            
            </div>
        
    </div>

<script>
    // --- SOUND HELPER FUNCTION ADDED HERE ---
    function playSound(elementId) {
        const audio = document.getElementById(elementId);
        if (audio && !audio.muted) {
            audio.currentTime = 0; // Rewind to start for quick successive plays
            audio.play().catch(e => console.log("Audio play failed:", e));
        }
    }
    
    // --- NEW: Global Sound and Help Functions ---
    let isSoundOn = true;

    function toggleSound() {
        isSoundOn = !isSoundOn;
        const soundButton = document.getElementById('sound-toggle');
        soundButton.textContent = isSoundOn ? '' : '';

        const allAudio = document.querySelectorAll('audio');
        allAudio.forEach(audio => {
            audio.muted = !isSoundOn;
        });
    }

    function openHelpFile() {
        window.open('HOWTOPLAY.pdf', '_blank');
    }
    // ----------------------------------------
    
    // --- 1. Game Constants & Setup ---
    const SUITS = ["clubs", "diamonds", "hearts", "spades"];
    const RANKS = Array.from({length: 13}, (_, i) => i + 2);
    const STARTING_CREDITS = 500;
    const INITIAL_BET = 5;
    const MOD_CARD_COST = 5;
    const CARD_IMAGE_PATH = 'cards/';
    const MODIFICATION_TIMEOUT = 1500;
    const COUNT_DURATION = 1000;
    
    // Paytable values
    const PAYTABLE = {
        "Royal Flush": 4000,
        "Straight Flush": 250,
        "Four of a Kind": 125,
        "Full House": 45,
        "Flush": 30,
        "Straight": 20,
        "Three of a Kind": 15,
        "Two Pair": 10,
        "Jacks or Better": 5,
        "Pair (Below Jacks)": 0,
        "High Card": 0,
        "Invalid Hand": 0
    };
    
    // **转拽 拽专**: 砖转 拽爪 转 注专 专住 驻注 - 专拽 转爪 转
    const ACTION_CARD_DEFINITIONS = [
        { name: "upgrade", display: "BOOSTER JOKER", filename: "booster_final.png", icon: '猬锔' }, 
        { name: "mirror_hand", display: "MIRROR JOKER", filename: "1.png", icon: '' }, 
        { name: "flush_fever", display: "FLUSH JOKER", filename: "FEVER.png", icon: '锔ｏワ锔' }, 
    ];
    
    function cardExists(hand, cardToCheck, indexToIgnore) {
        return hand.some((card, index) =>
            index !== indexToIgnore && card && card.isEqual(cardToCheck)
        );
    }
    
    // --- 2. Card Classes (No Change) ---
    class Card {
        constructor(suit, rank) {
            this.suit = suit;
            this.rank = rank;
            this.rankStr = this.getRankStr();
        }

        getRankStr() {
            const ranksMap = { 11: 'J', 12: 'Q', 13: 'K', 14: 'A' };
            return ranksMap[this.rank] || String(this.rank);
        }
        
        toString() {
            return ``; 
        }
        
        isEqual(otherCard) {
            return otherCard && this.suit === otherCard.suit && this.rank === otherCard.rank;
        }
        
        getImagePath() {
            return `${CARD_IMAGE_PATH}${this.rankStr}_of_${this.suit}.png`;
        }
        
        getColorClass() {
            return (this.suit === 'hearts' || this.suit === 'diamonds') ? 'red-suit' : '';
        }
    }

    class Deck {
        constructor() {
            this.cards = [];
            this.reset();
        }

        reset() {
            this.cards = [];
            for (const suit of SUITS) {
                for (const rank of RANKS) {
                    this.cards.push(new Card(suit, rank));
                }
            }
            this.shuffle();
        }

        shuffle() {
            for (let i = this.cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
            }
        }

        dealCard() {
            if (this.cards.length > 0) {
                return this.cards.pop();
            }
            return null;
        }

        drawCards(hand, heldIndices) {
            for (let i = 0; i < 5; i++) {
                if (!heldIndices.includes(i)) {
                    let newCard = null;
                    let attempts = 0;
                    
                    do {
                        newCard = this.dealCard();
                        attempts++;
                        if (attempts > this.cards.length + 10) break;
                    } while (newCard && cardExists(hand, newCard, i));
                    
                    if (newCard) {
                        hand[i] = newCard;
                    }
                }
            }
            this.shuffle();
        }
    }
    
    // --- 3. Evaluation Logic (No Change) ---
    function evaluateHand(hand) {
        if (!hand || hand.length !== 5) return "Invalid Hand";
        const ranks = hand.map(card => card.rank).sort((a, b) => a - b);
        const suits = hand.map(card => card.suit);
        const rankCounts = ranks.reduce((counts, rank) => {
            counts.set(rank, (counts.get(rank) || 0) + 1);
            return counts;
        }, new Map());

        const isFlush = new Set(suits).size === 1;
        const isSequential = ranks[4] - ranks[0] === 4 && new Set(ranks).size === 5;
        const isAceLow = ranks.toString() === '2,3,4,5,14';
        const isStraight = isSequential || isAceLow;
        
        let pairs = 0;
        let threes = 0;
        let fours = 0;
        
        for (const count of rankCounts.values()) {
            if (count === 4) fours++;
            else if (count === 3) threes++;
            else if (count === 2) pairs++;
        }

        if (isStraight && isFlush) {
            if (ranks.toString() === '10,11,12,13,14') return "Royal Flush";
            return "Straight Flush";
        }
        if (fours === 1) return "Four of a Kind";
        if (threes === 1 && pairs === 1) return "Full House";
        if (isFlush) return "Flush";
        if (isStraight) return "Straight";
        if (threes === 1) return "Three of a Kind";
        if (pairs === 2) return "Two Pair";
        
        if (pairs === 1) {
            for (const [rank, count] of rankCounts.entries()) {
                if (count === 2 && rank >= 11) return "Jacks or Better";
            }
            return "Pair (Below Jacks)";
        }
        return "High Card";
    }
    
    // Helper function to calculate potential modified card
    function getModifiedCard(card, hand, activeEffect, cardIndexToIgnore) {
        if (!card) return null;
        
        if (activeEffect === "upgrade") { // BOOSTER logic
            const newRank = card.rank + 1;
            if (newRank > 14) return null;
            return new Card(card.suit, newRank);
        } else if (activeEffect === "flush_fever") {
            const suitCounts = hand.reduce((counts, c) => {
                counts.set(c.suit, (counts.get(c.suit) || 0) + 1);
                return counts;
            }, new Map());
            
            let mostCommonSuit = null;
            let maxCount = 0;
            for (const [suit, count] of suitCounts.entries()) {
                if (count > maxCount) { maxCount = count; mostCommonSuit = suit; }
            }
            
            if (mostCommonSuit && card.suit !== mostCommonSuit) {
                return new Card(mostCommonSuit, card.rank);
            }
        }
        return null;
    }
    
    // ★ NEW: Get Dominant Suit for Flush Joker Icon ★
    function getDominantSuit(hand) {
        if (!hand || hand.length === 0) return '锔'; // Default
        
        const suitCounts = hand.reduce((counts, card) => {
            counts.set(card.suit, (counts.get(card.suit) || 0) + 1);
            return counts;
        }, new Map());

        let maxCount = 0;
        let dominantSuits = [];
        
        for (const [suit, count] of suitCounts.entries()) {
            if (count > maxCount) {
                maxCount = count;
                dominantSuits = [suit];
            } else if (count === maxCount) {
                dominantSuits.push(suit);
            }
        }
        
        if (dominantSuits.length === 0) return '锔'; // Should not happen with 5 cards
        
        // Convert suit name to symbol
        const suitSymbols = {
            'clubs': 'ｏ',
            'diamonds': '锔',
            'hearts': 'ワ',
            'spades': '锔'
        };

        // If multiple dominant suits (e.g., 2 spades, 2 hearts), choose the one with the highest ranked card
        if (dominantSuits.length > 1) {
            let highestRank = -1;
            let finalSuit = '';

            for (const suit of dominantSuits) {
                const highCardInSuit = hand.filter(card => card.suit === suit)
                                           .sort((a, b) => b.rank - a.rank)[0];
                if (highCardInSuit && highCardInSuit.rank > highestRank) {
                    highestRank = highCardInSuit.rank;
                    finalSuit = suit;
                }
            }
            return suitSymbols[finalSuit] || '锔';
        }

        return suitSymbols[dominantSuits[0]] || '锔';
    }


    // --- 4. Game Class (Full Logic) ---
    class PokerGame {
        constructor() {
            this.deck = new Deck();
            this.playerHand = [];
            this.heldCards = [false, false, false, false, false];
            
            // ★ MODIFIED: Simplified Action Card tracking ★
            this.actionCardsUsed = {
                "upgrade": false,
                "flush_fever": false,
                "mirror_hand": false
            }; 
            this.actionCardUsedThisRound = false; 

            this.credits = STARTING_CREDITS;
            this.bet = INITIAL_BET;
            this.modCardCost = MOD_CARD_COST;
            this.lastWinnings = 0;
            this.winningHandName = null;

            this.gameState = "DEAL";
            this.activeEffect = null; // Used temporarily during a Joker's execution
            this.isFirstDeal = true; 
            
            this.message = `Click 'DEAL' to start.`;
            
            this.updateUI();
        }
        
        handleActionButton() {
             if (this.gameState === "DEAL" || this.gameState === "END_ROUND") {
                 this.dealHand();
             } else if (this.gameState === "ACTION_PHASE") {
                 this.drawCards();
             }
        }
        
        dealHand() {
            const totalCost = this.bet + this.modCardCost;

            if (this.gameState !== "DEAL" && this.gameState !== "END_ROUND") return;


            if (this.credits < totalCost) {
                document.getElementById('message-area').textContent = `Not enough credits! Required: ${totalCost}.`;
                this.updateUI();
                return;
            }

            this.credits -= totalCost;

            
            this.deck.reset();
            this.playerHand = [];
            for (let i = 0; i < 5; i++) {
                const card = this.deck.dealCard();
                if (card) this.playerHand.push(card);
            }
            
            this.heldCards = [false, false, false, false, false];
            
            // ★ MODIFIED: Reset Action Card usage state ★
            this.actionCardUsedThisRound = false;
            this.activeEffect = null;
            this.actionCardsUsed = {
                "upgrade": false,
                "flush_fever": false,
                "mirror_hand": false
            };
            
            this.gameState = "ACTION_PHASE";
            
            const currentHandName = evaluateHand(this.playerHand);
            //  专砖转 注 拽驻:
            document.getElementById('message-area').textContent = "Use a Joker Icon or click cards to HOLD."; 
            document.getElementById('message-area').style.visibility = 'visible'; 
            
            document.getElementById('hand-status').textContent = currentHandName !== "High Card" && currentHandName !== "Pair (Below Jacks)" ? currentHandName : '';
            document.getElementById('hand-status').classList.toggle('winning-hand', currentHandName !== "High Card" && currentHandName !== "Pair (Below Jacks)s");

            this.updateUI();
            
            playSound('sound-deal-draw');
        }

        drawCards() {
            if (this.gameState !== "ACTION_PHASE") {
                document.getElementById('message-area').textContent = "Please hold cards or use a Joker.";
                this.updateUI();
                return;
            }
            
            document.getElementById('hand-status').textContent = '';
            document.getElementById('hand-status').classList.remove('winning-hand');

            const heldIndices = this.heldCards.map((held, i) => held ? i : -1).filter(i => i !== -1);
            this.deck.drawCards(this.playerHand, heldIndices);

            this.gameState = "EVALUATE";
            this.evaluateFinalHand();
            this.updateUI();
            
            playSound('sound-deal-draw');
        }
        
        animateCreditCount(amount) {
            // (Functionality remains the same)
            if (amount === 0) {
                this.updateUI();
                return;
            }

            const startCredits = this.credits;
            const endCredits = this.credits + amount;
            const startTime = performance.now();
            const creditsStatEl = document.getElementById('credits-stat');

            creditsStatEl.style.color = '#00CC00';
            creditsStatEl.style.fontSize = '1.3em';


            const step = (timestamp) => {
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / COUNT_DURATION, 1);
                
                const easedProgress = progress * progress * (3 - 2 * progress);
                
                const currentValue = Math.floor(startCredits + amount * easedProgress);

                creditsStatEl.textContent = currentValue;

                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    this.credits = endCredits;
                    creditsStatEl.textContent = endCredits;
                    
                    setTimeout(() => {
                        creditsStatEl.style.color = '#CCFF00';
                        creditsStatEl.style.fontSize = '';
                        this.updateUI();
                    }, 200);
                }
            };

            requestAnimationFrame(step);
        }
        
        evaluateFinalHand() {
            const handName = evaluateHand(this.playerHand);
            const winnings = PAYTABLE[handName] || 0;

            this.lastWinnings = winnings;
            this.winningHandName = handName;

            if (winnings > 0) {
                 this.message = `${handName} - ${winnings}`;
            } else {
                 this.message = `Click 'NEW HAND' to play.`;
            }
            
            this.gameState = "END_ROUND";
            
            document.getElementById('message-area').textContent = this.message;
            document.getElementById('message-area').style.visibility = 'visible';
            
            document.getElementById('hand-status').textContent = '';
            document.getElementById('hand-status').classList.remove('winning-hand');

            if (winnings > 0) {
                 playSound('sound-win');
            }
            
            this.animateCreditCount(winnings);
        }
        
        // ★ MODIFIED: Toggle Hold - only handles hold state ★
        toggleHold(cardIndex) {
            if (this.gameState === "ACTION_PHASE") { 
                this.heldCards[cardIndex] = !this.heldCards[cardIndex];
                
                const currentHandName = evaluateHand(this.playerHand);
                
                document.getElementById('message-area').textContent = "Use a Joker Icon or click cards to HOLD."; 
                document.getElementById('hand-status').textContent = currentHandName !== "High Card" && currentHandName !== "Pair (Below Jacks)" ? currentHandName : '';
                document.getElementById('hand-status').classList.toggle('winning-hand', currentHandName !== "High Card" && currentHandName !== "Pair (Below Jacks)s");
                
                this.updateUI();
                playSound('sound-hold');
            }
        }
        
        // ★ NEW: Function to handle all three actions (one-click) ★
        useCardAction(cardIndex, actionType) {
            if (this.gameState !== "ACTION_PHASE") return;
            
            if (this.actionCardUsedThisRound) {
                 document.getElementById('message-area').textContent = "Only one Joker per round is allowed.";
                 this.updateUI();
                 return;
            }
            
            // Mirror Hand can only be used once per hand (upgrade/flush are per round)
            if (actionType === 'mirror_hand' && this.actionCardsUsed[actionType]) {
                document.getElementById('message-area').textContent = "Mirror Joker already used.";
                this.updateUI();
                return;
            }

            // Set state and mark as used (before applying effect, in case it fails and needs rollback)
            this.activeEffect = actionType;
            this.actionCardUsedThisRound = true;
            this.actionCardsUsed[actionType] = true;

            this.applyActionCardEffect(cardIndex);
        }
        
        // ★ MODIFIED: Action Card Application Logic with FIX for immediate response ★
        applyActionCardEffect(clickedCardIndex) {
            const hand = this.playerHand;
            let cardModified = false;
            let cardToModify = clickedCardIndex !== null && clickedCardIndex !== undefined ? hand[clickedCardIndex] : null;

            // Helper function for quick rollback
            const rollback = (jokerType, message) => {
                 this.actionCardUsedThisRound = false;
                 this.actionCardsUsed[jokerType] = false;
                 this.activeEffect = null;
                 document.getElementById('message-area').textContent = message;
                 this.updateUI(); 
            };

            // 1. Logic for Mirror Hand
            if (this.activeEffect === "mirror_hand") {
                const cardsToModifyIndices = [];

                for (let i = 0; i < hand.length; i++) {
                    const cardOriginal = hand[i];
                    let newRank = cardOriginal.rank;

                    if (cardOriginal.rank === 2) newRank = 14; 
                    else if (cardOriginal.rank === 3) newRank = 13; 
                    else if (cardOriginal.rank === 4) newRank = 12; 

                    if (cardOriginal.rank !== newRank) {
                        const tempSimulatedCard = new Card(cardOriginal.suit, newRank);
                        
                        if (!cardExists(hand, tempSimulatedCard, i)) {
                            cardsToModifyIndices.push({ index: i, newRank: newRank });
                        }
                    }
                }
                
                cardsToModifyIndices.forEach(change => {
                    hand[change.index].rank = change.newRank;
                    hand[change.index].rankStr = hand[change.index].getRankStr();
                    cardModified = true;
                    
                    const cardEl = document.getElementById(`card-${change.index}`);
                    if (cardEl) {
                       cardEl.classList.add('modified');
                       // FIX: 住专转 拽住 专 爪,    转 -updateUI
                       setTimeout(() => {
                            cardEl.classList.remove('modified');
                       }, MODIFICATION_TIMEOUT);
                    }
                });
                
                document.getElementById('message-area').textContent = `Joker used. Click cards to HOLD or DRAW.`;
            }

            // 2. Logic for BOOSTER (Upgrade)
            else if (this.activeEffect === "upgrade" && cardToModify) {
                
                const newRank = cardToModify.rank + 1;
                
                if (newRank > 14) { 
                    rollback('upgrade', "Cannot upgrade an Ace. Choose another Joker/card."); 
                    return; 
                }
                if (cardExists(hand, new Card(cardToModify.suit, newRank), clickedCardIndex)) {
                    rollback('upgrade', 'Duplicate card. Choose another Joker/card.'); 
                    return; 
                }

                cardToModify.rank = newRank;
                cardToModify.rankStr = cardToModify.getRankStr();
                document.getElementById('message-area').textContent = "Joker used. Click cards to HOLD or DRAW.";
                cardModified = true;
            }
            
            // 3. Logic for Flush Fever
            else if (this.activeEffect === "flush_fever" && cardToModify) {
                
                const suitCounts = hand.reduce((counts, card) => {
                    counts.set(card.suit, (counts.get(card.suit) || 0) + 1);
                    return counts;
                }, new Map());
                
                let mostCommonSuit = null;
                let maxCount = 0;
                for (const [suit, count] of suitCounts.entries()) {
                    if (count > maxCount) {
                        maxCount = count;
                        mostCommonSuit = suit;
                    }
                }
                
                if (mostCommonSuit && cardToModify.suit !== mostCommonSuit) {
                    const tempSimulatedCard = new Card(mostCommonSuit, cardToModify.rank);

                    if (cardExists(hand, tempSimulatedCard, clickedCardIndex)) {
                         rollback('flush_fever', 'Duplicate card. Choose another Joker/card.');
                         return;
                    }
                    cardToModify.suit = mostCommonSuit;
                    cardModified = true;
                }
                document.getElementById('message-area').textContent = "Joker used. Click cards to HOLD or DRAW.";
            }
            
            // 锔 FIX: Final Animation and Update Control (Mede Immediate) 锔
            if (cardModified) {
                 if (clickedCardIndex !== null && clickedCardIndex !== undefined) {
                     document.getElementById(`card-${clickedCardIndex}`).classList.add('modified');
                     // FIX: 住专转 拽住 专 爪,    转 -updateUI
                     const cardEl = document.getElementById(`card-${clickedCardIndex}`);
                     if (cardEl) {
                         setTimeout(() => {
                             cardEl.classList.remove('modified');
                         }, MODIFICATION_TIMEOUT);
                     }
                 }
                 playSound('sound-action-card');
            } 
            
            // Clear active effect state
            this.activeEffect = null;
            
            // ★ FIX: 拽专 转 -updateUI ★
            this.updateUI();

            const currentHandName = evaluateHand(this.playerHand);
            document.getElementById('hand-status').textContent = currentHandName !== "High Card" && currentHandName !== "Pair (Below Jacks)" ? currentHandName : '';
            document.getElementById('hand-status').classList.toggle('winning-hand', currentHandName !== "High Card" && currentHandName !== "Pair (Below Jacks)s");
        }


        // --- UI Rendering Logic ---
        updateUI() {
            // Update Stats Bar (Local)
            document.getElementById('winnings-stat').textContent = this.lastWinnings;
            document.getElementById('bet-stat').textContent = this.bet + this.modCardCost;
            document.getElementById('credits-stat').textContent = this.credits; 
            
            const messageArea = document.getElementById('message-area');

            const actionButton = document.getElementById('action-button');
            
            if (this.gameState === "END_ROUND") {
                 actionButton.disabled = false;
                 actionButton.textContent = "NEW HAND";
                 messageArea.textContent = this.message;
                 messageArea.style.visibility = 'visible';
            } else if (this.gameState === "DEAL") {
                 actionButton.disabled = false;
                 actionButton.textContent = "DEAL";
                 messageArea.textContent = "Click 'DEAL' to start.";
                 messageArea.style.visibility = 'visible';
                 // ★ FIX: 驻住/住转专转 住住  爪 DEAL ★
                 document.getElementById('hand-status').textContent = '';
                 document.getElementById('hand-status').classList.remove('winning-hand');
            } else { // ACTION_PHASE
                 actionButton.disabled = false; // Always allow DRAW once in action phase
                 actionButton.textContent = "DRAW";
                 
                 const currentHandName = evaluateHand(this.playerHand);
                 document.getElementById('hand-status').textContent = currentHandName !== "High Card" && currentHandName !== "Pair (Below Jacks)" ? currentHandName : '';
                 
                 // Main instruction
                 messageArea.textContent = "Use a Joker Icon or click cards to HOLD.";
                 messageArea.style.visibility = 'visible';
            }

            // Update Payout Table Highlights (RESET and APPLY)
            const payoutRows = document.querySelectorAll('#payout-table tbody tr');
            payoutRows.forEach(row => {
                row.classList.remove('highlight-win');
                if (this.gameState === "END_ROUND" && row.getAttribute('data-hand') === this.winningHandName) {
                    row.classList.add('highlight-win');
                }
            });


            // ★ MODIFIED SECTION: Card Rendering ★
            const cardArea = document.getElementById('card-area');
            cardArea.innerHTML = '';
            
            const dominantSuitSymbol = getDominantSuit(this.playerHand);

            if (this.playerHand.length === 5) {
                this.playerHand.forEach((card, index) => {
                    const slot = document.createElement('div');
                    slot.className = 'card-slot';

                    // ★ NEW: HOLD Indicator element ★
                    const holdIndicator = document.createElement('div');
                    holdIndicator.className = 'hold-indicator';
                    holdIndicator.textContent = 'HELD';
                    if (this.heldCards[index]) holdIndicator.classList.add('held');
                    slot.appendChild(holdIndicator);
                    
                    // --- ★ NEW: BOOSTER ICON (Restored/Modified) ★ ---
                    const boosterIcon = document.createElement('button');
                    boosterIcon.className = 'card-action-icon booster-icon';
                    boosterIcon.textContent = '猬锔'; // Up arrow for BOOSTER
                    boosterIcon.title = "BOOSTER JOKER (Upgrade Card)";
                    boosterIcon.disabled = this.actionCardUsedThisRound;
                    boosterIcon.onclick = (e) => {
                         e.stopPropagation(); 
                         this.useCardAction(index, 'upgrade');
                    };
                    slot.appendChild(boosterIcon);
                    // --- ★ END NEW ★ ---

                    const cardDiv = document.createElement('div');
                    cardDiv.className = `card-image ${card.getColorClass()}`;
                    cardDiv.id = `card-${index}`;
                    
                    cardDiv.style.backgroundImage = `url('${card.getImagePath()}')`;
                    cardDiv.style.backgroundSize = 'cover';

                    if (cardDiv.style.backgroundImage.includes('.png') || cardDiv.style.backgroundImage.includes('.jpg')) {
                         cardDiv.classList.add('has-image');
                    } else {
                        cardDiv.classList.remove('has-image');
                    }

                    cardDiv.textContent = card.toString();
                    
                    cardDiv.onclick = () => this.toggleHold(index);

                    slot.appendChild(cardDiv);
                    
                    // --- ★ NEW: FLUSH JOKER ICON (Restored/Modified) ★ ---
                    const flushIcon = document.createElement('button');
                    flushIcon.className = 'card-action-icon flush-icon';
                    flushIcon.title = "FLUSH JOKER (Match Common Suit)";
                    flushIcon.disabled = this.actionCardUsedThisRound;
                    
                    const isRed = dominantSuitSymbol === 'ワ' || dominantSuitSymbol === '锔';
                    flushIcon.innerHTML = `<span class="${isRed ? 'red-suit-symbol' : 'black-suit-symbol'}">${dominantSuitSymbol}</span>`;
                    
                    flushIcon.onclick = (e) => {
                         e.stopPropagation(); 
                         this.useCardAction(index, 'flush_fever');
                    };
                    slot.appendChild(flushIcon);
                    // --- ★ END NEW ★ ---
                    
                    cardArea.appendChild(slot);
                });
            }
            // ★ END MODIFIED SECTION ★

            
            // Joker Card Display (Display Only - No inner icons/text)
            const actionContainer = document.getElementById('action-cards-container');
            actionContainer.innerHTML = '';
            
            const ACTION_CARD_IMAGE_PATH = 'Action_Cards/';
            
            ACTION_CARD_DEFINITIONS.forEach(ac => {
                const slot = document.createElement('div');
                slot.className = 'action-card-slot';
                
                if (this.actionCardsUsed[ac.name]) slot.classList.add('used');

                const button = document.createElement('button');
                button.className = 'action-card-button';
                
                if (ac.filename) {
                     button.style.backgroundImage = `url('${ACTION_CARD_IMAGE_PATH}${ac.filename}')`;
                     button.textContent = ''; 
                } else {
                     button.textContent = ac.display; 
                }

                button.disabled = true; // Make it non-functional
                
                slot.appendChild(button);
                
                // 锔 REMOVED: Display icon text below the image (as requested)
                
                actionContainer.appendChild(slot);
            });

            // Mirror Joker Button State
            const mirrorButtonContainer = document.getElementById('mirror-joker-container');
            if (mirrorButtonContainer) {
                 // ★ FIX: 爪 转 驻转专 专拽 爪 ACTION_PHASE ★
                 mirrorButtonContainer.style.visibility = this.gameState === "ACTION_PHASE" ? 'visible' : 'hidden';
                 mirrorButtonContainer.style.height = this.gameState === "ACTION_PHASE" ? 'auto' : '0';

                const actualButton = document.getElementById('mirror-joker-button');
                if (actualButton) {
                    actualButton.disabled = this.actionCardUsedThisRound;
                    
                    let text = ` MIRROR JOKER`; 
                    if (this.actionCardsUsed['mirror_hand']) {
                        text += ' - USED';
                    }
                    actualButton.textContent = text;
                }
            }
        }
        
        // Method to handle card preview on hover (Kept for compatibility, but not used by new icons)
        showCardPreview(index, cardEl) {
            const card = this.playerHand[index];
            const activeEffect = this.activeEffect;
            if (!activeEffect || activeEffect === 'mirror_hand') return;
            
            let modifiedCard = getModifiedCard(card, this.playerHand, activeEffect, index);
            
            if (modifiedCard) {
                let currentHandForLogic = this.playerHand.map(c => new Card(c.suit, c.rank));
                currentHandForLogic[index] = modifiedCard;

                if (cardExists(currentHandForLogic, modifiedCard, index)) return;


                let previewDiv = cardEl.querySelector('.preview-card');
                if (!previewDiv) {
                    previewDiv = document.createElement('div');
                    previewDiv.className = 'preview-card';
                    cardEl.appendChild(previewDiv);
                }

                const cardImagePath = modifiedCard.getImagePath();
                previewDiv.style.backgroundImage = `url('${cardImagePath}')`;
                
                previewDiv.textContent = modifiedCard.toString();
                previewDiv.style.color = modifiedCard.getColorClass() === 'red-suit' ? '#cc0000' : '#000';

                previewDiv.classList.add('visible');
            }
        }

        hideCardPreview(cardEl) {
            const previewDiv = cardEl.querySelector('.preview-card');
            if (previewDiv) {
                previewDiv.classList.remove('visible');
            }
        }
    }

    // Initialize the game when the script loads
    const game = new PokerGame();
    
    // Attach events for new global controls
    document.addEventListener('DOMContentLoaded', () => {
        const soundToggle = document.getElementById('sound-toggle');
        const helpButton = document.getElementById('help-button');

        if (soundToggle) {
             soundToggle.onclick = toggleSound;
        }
        if (helpButton) {
             helpButton.onclick = openHelpFile;
        }
    });

</script>

</body>
</html>